/*! pajamas - v1.5.4 - 2013-11-03
* http://documentup.com/geowa4/pajamas
* Copyright (c) 2013 ; Licensed MIT */
(function(e){"undefined"!=typeof module&&"object"==typeof module.exports?module.exports=e(require("q")):"function"==typeof define&&define.amd?define(["q"],e):this.pj=e(this.Q)})(function(Q){var win=window,doc=document,rurl=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,readyState="readyState",xmlHttpRequest="XMLHttpRequest",xhr=win[xmlHttpRequest]?function(){return new win[xmlHttpRequest]}:function(){return new win.ActiveXObject("Microsoft.XMLHTTP")},contentType="Content-Type",requestedWith="X-Requested-With",defaultHeaders={contentType:"application/x-www-form-urlencoded; charset=UTF-8",Accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},requestedWith:xmlHttpRequest},hasOwn=function(e,t){return e.hasOwnProperty(t)},isArray=Array.isArray||function(e){return e instanceof Array},isFunction=function(e){return"function"==typeof e},isNumeric=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},defaults=function(e,t){var r;for(r in t)!hasOwn(e,r)&&hasOwn(t,r)&&(e[r]=t[r]);return e},inferDataType=function(e){var t=e.substr(e.lastIndexOf(".")+1);return t===e?"json":"js"===t?"script":"txt"===t?"text":t},urlAppend=function(e,t){return"string"!=typeof t?e:e+(-1!==e.indexOf("?")?"&":"?")+t},setHeaders=function(e,t){var r,n=t.headers||{},a="Accept";hasOwn(n,a)?n[a]||delete n[a]:n[a]=defaultHeaders[a][t.dataType]||defaultHeaders[a]["*"],hasOwn(n,requestedWith)?n[requestedWith]||delete n[requestedWith]:t.crossDomain||(n[requestedWith]=defaultHeaders.requestedWith),hasOwn(n,contentType)?n[contentType]||delete n[contentType]:n[contentType]=t.contentType||defaultHeaders.contentType;for(r in n)hasOwn(n,r)&&e.setRequestHeader(r,n[r])},makeResolution=function(e,t,r){return r?{response:t,status:e.status,xhr:e}:t},responseParsers={json:function(){var r=this.responseText;try{return win.JSON?win.JSON.parse(r):eval("("+r+")")}catch(err){throw Error("Could not parse JSON in response.")}},script:function(){return eval(this.responseText)},text:function(){return this.responseText+""},html:function(){return this.responseText},xml:function(){var e=this.responseXML;return null===e||null===e.documentElement||"parsererror"===e.documentElement.nodeName?null:e}},isCrossDomain=function(e,t){var r=rurl.exec(e),n=rurl.exec(t);return!(!r||r[1]===n[1]&&r[2]===n[2]&&(r[3]||("http:"===r[1]?80:443))===(n[3]||("http:"===n[1]?80:443)))},sendLocal=function(e,t){var r,n=isFunction(e.xhr)?e.xhr():xhr(),a=function(){try{n.send(e.data)}catch(r){r.xhr=n,t.reject(r)}};n.open(e.type,e.url,!0),setHeaders(n,e),n.onreadystatechange=function(){var a,o,s;if(r&&clearTimeout(r),n&&4===n[readyState])if(a=n.status,a>=200&&300>a||304===a||0===a&&""!==n.responseText)if(n.responseText)try{o=responseParsers[e.dataType],t.resolve(makeResolution(n,o?o.call(n):n,e.verboseResolution))}catch(u){u.xhr=n,t.reject(u)}else t.resolve(makeResolution(n,null,e.verboseResolution));else s=Error(e.type+" "+e.url+": "+n.status+" "+n.statusText),s.type=e.type,s.url=e.url,s.status=n.status,s.statusText=n.statusText,s.xhr=n,t.reject(s)},isNumeric(e.timeout)&&(r=setTimeout(function(){var e=Error("timeout");e.xhr=n,n.abort(),t.reject(e)},e.timeout)),isNumeric(e.delay)?setTimeout(function(){a()},e.delay):a()},sendRemote=function(e,t){var r,n,a,o=document.head||document.getElementsByTagName("head")[0]||document.documentElement,s=document.createElement("script"),u=function(){s&&o.appendChild(s)};s.async="async","jsonp"===e.dataType?(r=e.jsonp||"pajamas"+Math.floor(1e3*Math.random())+(Date.now||function(){return(new Date).getTime()}).call(),n=function(e){window[r]=void 0;try{delete window[r]}catch(n){}t.resolve(e)},window[r]=n,e.url+=(e.url.indexOf("?")>-1?"&":"?")+(e.jsonp||"callback")+"="+r,s.src=e.url):s.src=e.url,s.onload=s.onreadystatechange=function(r,n){(n||!s.readyState||/loaded|complete/.test(s.readyState))&&(s.onload=s.onreadystatechange=null,o&&s.parentNode&&o.removeChild(s),s=void 0,a&&clearTimeout(a),n?t.reject(Error(e.url+" aborted")):"jsonp"!==e.dataType&&t.resolve())},s.onerror=function(){t.reject(Error("Error loading "+e.url))},isNumeric(e.timeout)&&(a=setTimeout(function(){s.onload(0,1),t.reject(Error("timeout"))},e.timeout)),isNumeric(e.delay)?setTimeout(function(){u()},e.delay):u()},pajamas=function(e){var t=Q.defer(),r=t.promise,n=null==e?{}:defaults({},e),a=function(){var e;try{return location.href}catch(t){return e=doc.createElement("a"),e.href="",e.href}}();return n.type=n.type?n.type.toUpperCase():"GET",n.url||(n.url=a),n.data=n.data&&n.processData!==!1&&"string"!=typeof n.data?pajamas.param(n.data):n.data||null,n.dataType||(n.dataType=inferDataType(n.url)),null!=n.crossDomain||(n.crossDomain=isCrossDomain(n.url,a)),n.data&&"string"==typeof n.data&&"GET"===n.type&&(n.url=urlAppend(n.url,n.data),n.data=null),n.crossDomain||"jsonp"===n.dataType?sendRemote(n,t):sendLocal(n,t),r.then(function(e){var t=n.success&&n.success(e);return t||e},function(e){var t;if(isNumeric(n.retry)&&n.retry>0)return n.retry--,pajamas(n);if(n.retry===Object(n.retry))return pajamas(n.retry);if(t=n.error&&n.error(e))return t;throw e})};return pajamas.partial=function(e){return function(t){var r=defaults({},e);return pajamas(defaults(r,t||{}))}},pajamas.param=function(e){var t,r=[],n=function(e,t){var n=encodeURIComponent;t=isFunction(t)?t():null==t?"":t,r.push(n(e)+"="+n(t))},a=function(e,t){var r,o,s;if(isArray(t))for(o=0;t.length>o;o++)s=t[o],/\[\]$/.test(e)?n(e,s):a(e+"["+("object"==typeof s?o:"")+"]",s);else if(t&&"object"==typeof t)for(r in t)hasOwn(t,r)&&a(e+"["+r+"]",t[r]);else n(e,t)};if(isArray(e))for(t=0;e.length>t;t++)n(e[t].name,e[t].value);else for(t in e)hasOwn(e,t)&&a(t,e[t]);return r.join("&").replace(/%20/g,"+")},pajamas.val=function(e){var t;if("select"===e.nodeName.toLowerCase())t=function(){var t,r,n,a,o=[],s=e.selectedIndex,u=e.options,i="select-one"===e.type;if(0>s)return null;for(n=i?s:0,a=i?s+1:u.length;a>n;n++)if(r=u[n],r.selected&&!r.disabled&&(!r.parentNode.disabled||"optgroup"!==r.parentNode.nodeName.toLowerCase())){if(t=pajamas.val(r),i)return t;o.push(t)}return o}();else{if("option"===e.nodeName.toLowerCase())return t=e.attributes.value,!t||t.specified?e.value:e.text;if("button"===e.type||"button"===e.nodeName.toLowerCase())return t=e.getAttributeNode("value"),t?t.value:void 0;if("radio"===e.type||"checkbox"===e.type)return null===e.getAttribute("value")?"on":e.value;t=e.value}return"string"==typeof t?t.replace(/\r/g,""):null==t?"":t},pajamas.serializeArray=function(){var e,t,r=[],n=/\r?\n/g,a=/radio|checkbox/i,o=function(e){var t,o,s,u;for(s=0;e.length>s;s++)if(t=e[s],t.name&&!t.disabled&&(a.test(t.type)?t.checked:!0)&&(o=pajamas.val(t),null!=o))if(isArray(o))for(u=0;o.length>u;u++)r.push({name:t.name,value:o[u].replace(n,"\r\n")});else r.push({name:t.name,value:o.replace(n,"\r\n")})};for(e=0;arguments.length>e;e++)t=arguments[e],t.elements?o(t.elements):o([t]);return r},pajamas.serialize=function(){return pajamas.param(pajamas.serializeArray.apply(null,arguments))},pajamas});