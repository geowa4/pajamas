/*! pajamas - v1.3.5 - 2013-03-12
* http://documentup.com/geowa4/pajamas
* Copyright (c) 2013 ; Licensed MIT */
!function(e){"undefined"!=typeof module&&"object"==typeof module.exports?module.exports=e(require("q")):"function"==typeof define&&define.amd?define(["q"],e):this.pj=e(this.Q)}(function(Q){var win=window,doc=document,rurl=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,readyState="readyState",xmlHttpRequest="XMLHttpRequest",xhr=win[xmlHttpRequest]?function(){return new win[xmlHttpRequest]}:function(){return new win.ActiveXObject("Microsoft.XMLHTTP")},contentType="Content-Type",requestedWith="X-Requested-With",defaultHeaders={contentType:"application/x-www-form-urlencoded; charset=UTF-8",Accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},requestedWith:xmlHttpRequest},isArray=Array.isArray||function(e){return e instanceof Array},isFunction=function(e){return"function"==typeof e},isNumeric=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},defaults=function(e,t){var r;for(r in t)!e.hasOwnProperty(r)&&t.hasOwnProperty(r)&&(e[r]=t[r]);return e},inferDataType=function(e){var t=e.substr(e.lastIndexOf(".")+1);return t===e?"json":"js"===t?"script":"txt"===t?"text":t},urlAppend=function(e,t){return"string"!=typeof t?e:e+(-1!==e.indexOf("?")?"&":"?")+t},setHeaders=function(e,t){var r,a=t.headers||{},n="Accept";a[n]=a[n]||defaultHeaders[n][t.dataType]||defaultHeaders[n]["*"],t.crossDomain||a[requestedWith]||(a[requestedWith]=defaultHeaders.requestedWith),a[contentType]||(a[contentType]=t.contentType||defaultHeaders.contentType);for(r in a)a.hasOwnProperty(r)&&e.setRequestHeader(r,a[r])},defaultParser=function(e){e.resolve(this)},responseParsers={json:function(deferred){var r=this.responseText;try{r=win.JSON?win.JSON.parse(r):eval("("+r+")"),deferred.resolve(r)}catch(err){deferred.reject(Error("Could not parse JSON in response."))}},script:function(deferred){try{deferred.resolve(eval(this.responseText))}catch(err){deferred.reject(err)}},text:function(e){e.resolve(this.responseText+"")},html:function(e){e.resolve(this.responseText)},xml:function(e){var t=this.responseXML;null===t||null===t.documentElement||"parsererror"===t.documentElement.nodeName?e.resolve(null):e.resolve(t)}},isCrossDomain=function(e,t){var r=rurl.exec(e),a=rurl.exec(t);return!(!r||r[1]===a[1]&&r[2]===a[2]&&(r[3]||("http:"===r[1]?80:443))===(a[3]||("http:"===a[1]?80:443)))},sendLocal=function(e,t){var r,a=isFunction(e.xhr)?e.xhr():xhr(),n=function(){try{a.send(e.data)}catch(r){t.reject(r)}};a.open(e.type,e.url,!0),setHeaders(a,e),a.onreadystatechange=function(){var n,o;r&&clearTimeout(r),a&&4===a[readyState]&&(n=a.status,n>=200&&300>n||304===n||0===n&&""!==a.responseText?a.responseText?(responseParsers[e.dataType]||defaultParser).call(a,t):t.resolve(null):(o=Error(e.type+" "+e.url+": "+a.status+" "+a.statusText),o.type=e.type,o.url=e.url,o.status=a.status,o.statusText=a.statusText,t.reject(o)))},isNumeric(e.timeout)&&(r=setTimeout(function(){a.abort(),t.reject(Error("timeout"))},e.timeout)),isNumeric(e.delay)?setTimeout(function(){n()},e.delay):n()},sendRemote=function(e,t){var r,a,n,o=document.head||document.getElementsByTagName("head")[0]||document.documentElement,s=document.createElement("script"),i=function(){s&&o.appendChild(s)};s.async="async","jsonp"===e.dataType?(r=e.jsonp||"pajamas"+(Date.now||function(){return(new Date).getTime()}).call(),a=function(e){window[r]=void 0;try{delete window[r]}catch(a){}t.resolve(e)},window[r]=a,e.url+=(e.url.indexOf("?")>-1?"&":"?")+(e.jsonp||"callback")+"="+r,s.src=e.url):s.src=e.url,s.onload=s.onreadystatechange=function(r,a){(a||!s.readyState||/loaded|complete/.test(s.readyState))&&(s.onload=s.onreadystatechange=null,o&&s.parentNode&&o.removeChild(s),s=void 0,n&&clearTimeout(n),a?t.reject(Error(e.url+" aborted")):"jsonp"!==e.dataType&&t.resolve())},isNumeric(e.timeout)&&(n=setTimeout(function(){s.onload(0,1),t.reject(Error("timeout"))},e.timeout)),isNumeric(e.delay)?setTimeout(function(){i()},e.delay):i()},pajamas=function(e){var t=Q.defer(),r=t.promise,a=null==e?{}:defaults({},e),n=function(){var e;try{return location.href}catch(t){return e=doc.createElement("a"),e.href="",e.href}}();return a.type=a.type?a.type.toUpperCase():"GET",a.url||(a.url=n),a.data=a.data&&a.processData!==!1&&"string"!=typeof a.data?pajamas.param(a.data):a.data||null,a.dataType||(a.dataType=inferDataType(a.url)),a.crossDomain||(a.crossDomain=isCrossDomain(a.url,n)),a.data&&"string"==typeof a.data&&"GET"===a.type&&(a.url=urlAppend(a.url,a.data),a.data=null),a.crossDomain||"jsonp"===a.dataType?sendRemote(a,t):sendLocal(a,t),r.then(function(e){var t=a.success&&a.success(e);return t||e},function(e){var t;if(isNumeric(a.retry)&&a.retry>0)return a.retry--,pajamas(a);if(a.retry===Object(a.retry))return pajamas(a.retry);if(t=a.error&&a.error(e))return t;throw e})};return pajamas.partial=function(e){var t=function(t){pajamas(defaults(t||{},e))};return defaults(t,pajamas)},pajamas.param=function(e){var t,r=[],a=function(e,t){var a=encodeURIComponent;t=isFunction(t)?t():null==t?"":t,r.push(a(e)+"="+a(t))},n=function(e,t){var r,o,s;if(isArray(t))for(o=0;t.length>o;o++)s=t[o],/\[\]$/.test(e)?a(e,s):n(e+"["+("object"==typeof s?o:"")+"]",s);else if(t&&"object"==typeof t)for(r in t)t.hasOwnProperty(r)&&n(e+"["+r+"]",t[r]);else a(e,t)};if(isArray(e))for(t=0;e.length>t;t++)a(e[t].name,e[t].value);else for(t in e)e.hasOwnProperty(t)&&n(t,e[t]);return r.join("&").replace(/%20/g,"+")},pajamas.val=function(e){var t;if("select"===e.nodeName.toLowerCase())t=function(){var t,r,a,n,o=[],s=e.selectedIndex,i=e.options,u="select-one"===e.type;if(0>s)return null;for(a=u?s:0,n=u?s+1:i.length;n>a;a++)if(r=i[a],r.selected&&!r.disabled&&(!r.parentNode.disabled||"optgroup"!==r.parentNode.nodeName.toLowerCase())){if(t=pajamas.val(r),u)return t;o.push(t)}return o}();else{if("option"===e.nodeName.toLowerCase())return t=e.attributes.value,!t||t.specified?e.value:e.text;if("button"===e.type||"button"===e.nodeName.toLowerCase())return t=e.getAttributeNode("value"),t?t.value:void 0;if("radio"===e.type||"checkbox"===e.type)return null===e.getAttribute("value")?"on":e.value;t=e.value}return"string"==typeof t?t.replace(/\r/g,""):null==t?"":t},pajamas.serializeArray=function(){var e,t,r=[],a=/\r?\n/g,n=/radio|checkbox/i,o=function(e){var t,o,s,i;for(s=0;e.length>s;s++)if(t=e[s],t.name&&!t.disabled&&(n.test(t.type)?t.checked:!0)&&(o=pajamas.val(t),null!=o))if(isArray(o))for(i=0;o.length>i;i++)r.push({name:t.name,value:o[i].replace(a,"\r\n")});else r.push({name:t.name,value:o.replace(a,"\r\n")})};for(e=0;arguments.length>e;e++)t=arguments[e],t.elements?o(t.elements):o([t]);return r},pajamas.serialize=function(){return pajamas.param(pajamas.serializeArray.apply(null,arguments))},pajamas});