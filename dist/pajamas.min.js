/*! pajamas - v1.3.2 - 2013-01-01
* http://documentup.com/geowa4/pajamas
* Copyright (c) 2013 George Adams IV (http://gada.ms); Licensed MIT */
!function(e){typeof module!="undefined"&&typeof module.exports=="object"?module.exports=e(require("q")):typeof define=="function"&&define.amd?define(["q"],e):this.pj=e(this.Q)}(function(Q){var win=window,doc=document,rurl=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,readyState="readyState",xmlHttpRequest="XMLHttpRequest",xhr=win[xmlHttpRequest]?function(){return new win[xmlHttpRequest]}:function(){return new win.ActiveXObject("Microsoft.XMLHTTP")},contentType="Content-Type",requestedWith="X-Requested-With",defaultHeaders={contentType:"application/x-www-form-urlencoded; charset=UTF-8",Accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},requestedWith:xmlHttpRequest},isArray=Array.isArray||function(e){return e instanceof Array},isFunction=typeof /-/!="function"?function(e){return typeof e=="function"}:function(e){return Object.prototype.toString.call(e)==="[object Function]"},isNumeric=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},clone=function(e){var t={},n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},inferDataType=function(e){var t=e.substr(e.lastIndexOf(".")+1);return t===e?"json":t==="js"?"script":t==="txt"?"text":t},urlAppend=function(e,t){return typeof t!="string"?e:e+(e.indexOf("?")!==-1?"&":"?")+t},setHeaders=function(e,t){var n=t.headers||{},r="Accept",i;n[r]=n[r]||defaultHeaders[r][t.dataType]||defaultHeaders[r]["*"],!t.crossDomain&&!n[requestedWith]&&(n[requestedWith]=defaultHeaders.requestedWith),n[contentType]||(n[contentType]=t.contentType||defaultHeaders.contentType);for(i in n)n.hasOwnProperty(i)&&e.setRequestHeader(i,n[i])},defaultParser=function(e){e.resolve(this)},responseParsers={json:function(deferred){var r=this.responseText;try{r=win.JSON?win.JSON.parse(r):eval("("+r+")"),deferred.resolve(r)}catch(err){deferred.reject(new Error("Could not parse JSON in response."))}},script:function(deferred){try{deferred.resolve(eval(this.responseText))}catch(err){deferred.reject(err)}},text:function(e){e.resolve(String(this.responseText))},html:function(e){e.resolve(this.responseText)},xml:function(e){var t=this.responseXML;t===null||t.documentElement===null||t.documentElement.nodeName==="parsererror"?e.resolve(null):e.resolve(t)}},isCrossDomain=function(e,t){var n=rurl.exec(e),r=rurl.exec(t);return!(!n||n[1]===r[1]&&n[2]===r[2]&&(n[3]||(n[1]==="http:"?80:443))===(r[3]||(r[1]==="http:"?80:443)))},sendLocal=function(e,t){var n=isFunction(e.xhr)?e.xhr():xhr(),r,i=function(){try{n.send(e.data)}catch(r){t.reject(r)}};n.open(e.type,e.url,!0),setHeaders(n,e),n.onreadystatechange=function(){var i,s;r&&clearTimeout(r),n&&n[readyState]===4&&(i=n.status,i>=200&&i<300||i===304||i===0&&n.responseText!==""?n.responseText?(responseParsers[e.dataType]||defaultParser).call(n,t):t.resolve(null):(s=new Error(e.type+" "+e.url+": "+n.status+" "+n.statusText),s.type=e.type,s.url=e.url,s.status=n.status,s.statusText=n.statusText,t.reject(s)))},isNumeric(e.timeout)&&(r=setTimeout(function(){n.abort(),t.reject(new Error("timeout"))},e.timeout)),isNumeric(e.delay)?setTimeout(function(){i()},e.delay):i()},sendRemote=function(e,t){var n=document.head||document.getElementsByTagName("head")[0]||document.documentElement,r=document.createElement("script"),i,s,o,u=function(){r&&n.appendChild(r)};r.async="async",e.dataType==="jsonp"?(i=e.jsonp||"pajamas"+(Date.now||function(){return(new Date).getTime()}).call(),s=function(e){window[i]=undefined;try{delete window[i]}catch(n){}t.resolve(e)},window[i]=s,e.url+=(e.url.indexOf("?")>-1?"&":"?")+(e.jsonp||"callback")+"="+i,r.src=e.url):r.src=e.url,r.onload=r.onreadystatechange=function(i,s){if(s||!r.readyState||/loaded|complete/.test(r.readyState))r.onload=r.onreadystatechange=null,n&&r.parentNode&&n.removeChild(r),r=undefined,o&&clearTimeout(o),s?t.reject(new Error(e.url+" aborted")):e.dataType!=="jsonp"&&t.resolve()},isNumeric(e.timeout)&&(o=setTimeout(function(){r.onload(0,1),t.reject(new Error("timeout"))},e.timeout)),isNumeric(e.delay)?setTimeout(function(){u()},e.delay):u()},pajamas=function(e){var t=Q.defer(),n=t.promise,r=e==null?{}:clone(e),i=function(){var e;try{return location.href}catch(t){return e=doc.createElement("a"),e.href="",e.href}}();return r.type=r.type?r.type.toUpperCase():"GET",r.url||(r.url=i),r.data=r.data&&r.processData!==!1&&typeof r.data!="string"?pajamas.param(r.data):r.data||null,r.dataType||(r.dataType=inferDataType(r.url)),r.crossDomain||(r.crossDomain=isCrossDomain(r.url,i)),r.data&&typeof r.data=="string"&&r.type==="GET"&&(r.url=urlAppend(r.url,r.data),r.data=null),!r.crossDomain&&r.dataType!=="jsonp"?sendLocal(r,t):sendRemote(r,t),n.then(function(e){var t=r.success&&r.success(e);return t||e},function(e){var t;if(isNumeric(r.retry)&&r.retry>0)return r.retry--,pajamas(r);if(r.retry===Object(r.retry))return pajamas(r.retry);t=r.error&&r.error(e);if(t)return t;throw e})};return pajamas.param=function(e){var t,n=[],r=function(e,t){var r=encodeURIComponent;t=isFunction(t)?t():t==null?"":t,n.push(r(e)+"="+r(t))},i=function(e,t){var n,s,o;if(isArray(t))for(s=0;s<t.length;s++)o=t[s],/\[\]$/.test(e)?r(e,o):i(e+"["+(typeof o=="object"?s:"")+"]",o);else if(t&&typeof t=="object")for(n in t)t.hasOwnProperty(n)&&i(e+"["+n+"]",t[n]);else r(e,t)};if(isArray(e))for(t=0;t<e.length;t++)r(e[t].name,e[t].value);else for(t in e)e.hasOwnProperty(t)&&i(t,e[t]);return n.join("&").replace(/%20/g,"+")},pajamas.val=function(e){var t;if(e.nodeName.toLowerCase()==="select")t=function(){var t,n=[],r=e.selectedIndex,i,s=e.options,o=e.type==="select-one",u,a;if(r<0)return null;u=o?r:0,a=o?r+1:s.length;for(;u<a;u++){i=s[u];if(i.selected&&!i.disabled&&(!i.parentNode.disabled||i.parentNode.nodeName.toLowerCase()!=="optgroup")){t=pajamas.val(i);if(o)return t;n.push(t)}}return n}();else{if(e.nodeName.toLowerCase()==="option")return t=e.attributes.value,!t||t.specified?e.value:e.text;if(e.type==="button"||e.nodeName.toLowerCase()==="button")return t=e.getAttributeNode("value"),t?t.value:undefined;if(e.type==="radio"||e.type==="checkbox")return e.getAttribute("value")===null?"on":e.value;t=e.value}return typeof t=="string"?t.replace(/\r/g,""):t==null?"":t},pajamas.serializeArray=function(){var e=[],t,n,r=/\r?\n/g,i=/radio|checkbox/i,s=function(t){var n,s,o,u;for(o=0;o<t.length;o++){n=t[o];if(n.name&&!n.disabled&&(i.test(n.type)?n.checked:!0)){s=pajamas.val(n);if(s!=null)if(isArray(s))for(u=0;u<s.length;u++)e.push({name:n.name,value:s[u].replace(r,"\r\n")});else e.push({name:n.name,value:s.replace(r,"\r\n")})}}};for(t=0;t<arguments.length;t++)n=arguments[t],n.elements?s(n.elements):s([n]);return e},pajamas.serialize=function(){return pajamas.param(pajamas.serializeArray.apply(null,arguments))},pajamas});