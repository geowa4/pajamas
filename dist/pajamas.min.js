/*! pajamas - v1.6.0 - 2013-11-03
* http://documentup.com/geowa4/pajamas
* Copyright (c) 2013 ; Licensed MIT */
!function(a){"undefined"!=typeof module&&"object"==typeof module.exports?module.exports=a(require("q")):"function"==typeof define&&define.amd?define(["q"],a):this.pj=a(this.Q)}(function(Q){var win=window,doc=document,rurl=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,readyState="readyState",xmlHttpRequest="XMLHttpRequest",xhr=win[xmlHttpRequest]?function(){return new win[xmlHttpRequest]}:function(){return new win.ActiveXObject("Microsoft.XMLHTTP")},contentType="Content-Type",requestedWith="X-Requested-With",defaultHeaders={contentType:"application/x-www-form-urlencoded; charset=UTF-8",Accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},requestedWith:xmlHttpRequest},hasOwn=function(a,b){return a.hasOwnProperty(b)},isArray=Array.isArray||function(a){return a instanceof Array},isFunction="function"!=typeof/-/?function(a){return"function"==typeof a}:function(a){return"[object Function]"===Object.prototype.toString.call(a)},isNumeric=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},defaults=function(a,b){var c;for(c in b)!hasOwn(a,c)&&hasOwn(b,c)&&(a[c]=b[c]);return a},inferDataType=function(a){var b=a.substr(a.lastIndexOf(".")+1);return b===a?"json":"js"===b?"script":"txt"===b?"text":b},urlAppend=function(a,b){return"string"!=typeof b?a:a+(-1!==a.indexOf("?")?"&":"?")+b},setHeaders=function(a,b){var c,d=b.headers||{},e="Accept";hasOwn(d,e)?d[e]||delete d[e]:d[e]=defaultHeaders[e][b.dataType]||defaultHeaders[e]["*"],hasOwn(d,requestedWith)?d[requestedWith]||delete d[requestedWith]:b.crossDomain||(d[requestedWith]=defaultHeaders.requestedWith),hasOwn(d,contentType)?d[contentType]||delete d[contentType]:d[contentType]=b.contentType||defaultHeaders.contentType;for(c in d)hasOwn(d,c)&&a.setRequestHeader(c,d[c])},makeResolution=function(a,b,c){return c?{response:b,status:a.status,xhr:a}:b},responseParsers={json:function(){var r=this.responseText;try{return win.JSON?win.JSON.parse(r):eval("("+r+")")}catch(err){throw new Error("Could not parse JSON in response.")}},script:function(){return eval(this.responseText)},text:function(){return String(this.responseText)},html:function(){return this.responseText},xml:function(){var a=this.responseXML;return null===a||null===a.documentElement||"parsererror"===a.documentElement.nodeName?null:a}},isCrossDomain=function(a,b){var c=rurl.exec(a),d=rurl.exec(b);return!(!c||c[1]===d[1]&&c[2]===d[2]&&(c[3]||("http:"===c[1]?80:443))===(d[3]||("http:"===d[1]?80:443)))},sendLocal=function(a,b){var c,d=isFunction(a.xhr)?a.xhr():xhr(),e=function(){try{d.send(a.data)}catch(c){c.xhr=d,b.reject(c)}};d.open(a.type,a.url,!0),setHeaders(d,a),d.onreadystatechange=function(){var e,f,g;if(c&&clearTimeout(c),d&&4===d[readyState])if(e=d.status,e>=200&&300>e||304===e||0===e&&""!==d.responseText)if(d.responseText)try{f=responseParsers[a.dataType],b.resolve(makeResolution(d,f?f.call(d):d,a.verboseResolution))}catch(h){h.xhr=d,b.reject(h)}else b.resolve(makeResolution(d,null,a.verboseResolution));else g=new Error(a.type+" "+a.url+": "+d.status+" "+d.statusText),g.type=a.type,g.url=a.url,g.status=d.status,g.statusText=d.statusText,g.xhr=d,b.reject(g)},isNumeric(a.timeout)&&(c=setTimeout(function(){var a=new Error("timeout");a.xhr=d,d.abort(),b.reject(a)},a.timeout)),isNumeric(a.delay)?setTimeout(function(){e()},a.delay):e()},sendRemote=function(a,b){var c,d,e,f=document.head||document.getElementsByTagName("head")[0]||document.documentElement,g=document.createElement("script"),h=function(){g&&f.appendChild(g)};g.async="async","jsonp"===a.dataType?(c=a.jsonp||"pajamas"+Math.floor(1e3*Math.random())+(Date.now||function(){return(new Date).getTime()}).call(),d=function(a){window[c]=void 0;try{delete window[c]}catch(d){}b.resolve(a)},window[c]=d,a.url+=(a.url.indexOf("?")>-1?"&":"?")+(a.jsonp||"callback")+"="+c,g.src=a.url):g.src=a.url,g.onload=g.onreadystatechange=function(c,d){(d||!g.readyState||/loaded|complete/.test(g.readyState))&&(g.onload=g.onreadystatechange=null,f&&g.parentNode&&f.removeChild(g),g=void 0,e&&clearTimeout(e),d?b.reject(new Error(a.url+" aborted")):"jsonp"!==a.dataType&&b.resolve())},g.onerror=function(){b.reject(new Error("Error loading "+a.url))},isNumeric(a.timeout)&&(e=setTimeout(function(){g.onload(0,1),b.reject(new Error("timeout"))},a.timeout)),isNumeric(a.delay)?setTimeout(function(){h()},a.delay):h()},pajamas=function(a){var b=Q.defer(),c=b.promise,d=null==a?{}:defaults({},a),e=function(){var a;try{return location.href}catch(b){return a=doc.createElement("a"),a.href="",a.href}}();return d.type=d.type?d.type.toUpperCase():"GET",d.url||(d.url=e),d.data=d.data&&d.processData!==!1&&"string"!=typeof d.data?pajamas.param(d.data):d.data||null,d.dataType||(d.dataType=inferDataType(d.url)),null!=d.crossDomain||(d.crossDomain=isCrossDomain(d.url,e)),d.data&&"string"==typeof d.data&&"GET"===d.type&&(d.url=urlAppend(d.url,d.data),d.data=null),d.crossDomain||"jsonp"===d.dataType?sendRemote(d,b):sendLocal(d,b),c.then(function(a){var b=d.success&&d.success(a);return b||a},function(a){var b;if(isNumeric(d.retry)&&d.retry>0)return d.retry--,pajamas(d);if(d.retry===Object(d.retry))return pajamas(d.retry);if(b=d.error&&d.error(a))return b;throw a})};return pajamas.partial=function(a){return function(b){var c=defaults({},a);return pajamas(defaults(c,b||{}))}},pajamas.param=function(a){var b,c=[],d=function(a,b){var d=encodeURIComponent;b=isFunction(b)?b():null==b?"":b,c.push(d(a)+"="+d(b))},e=function(a,b){var c,f,g;if(isArray(b))for(f=0;f<b.length;f++)g=b[f],/\[\]$/.test(a)?d(a,g):e(a+"["+("object"==typeof g?f:"")+"]",g);else if(b&&"object"==typeof b)for(c in b)hasOwn(b,c)&&e(a+"["+c+"]",b[c]);else d(a,b)};if(isArray(a))for(b=0;b<a.length;b++)d(a[b].name,a[b].value);else for(b in a)hasOwn(a,b)&&e(b,a[b]);return c.join("&").replace(/%20/g,"+")},pajamas.val=function(a){var b;if("select"===a.nodeName.toLowerCase())b=function(){var b,c,d,e,f=[],g=a.selectedIndex,h=a.options,i="select-one"===a.type;if(0>g)return null;for(d=i?g:0,e=i?g+1:h.length;e>d;d++)if(c=h[d],c.selected&&!c.disabled&&(!c.parentNode.disabled||"optgroup"!==c.parentNode.nodeName.toLowerCase())){if(b=pajamas.val(c),i)return b;f.push(b)}return f}();else{if("option"===a.nodeName.toLowerCase())return b=a.attributes.value,!b||b.specified?a.value:a.text;if("button"===a.type||"button"===a.nodeName.toLowerCase())return b=a.getAttributeNode("value"),b?b.value:void 0;if("radio"===a.type||"checkbox"===a.type)return null===a.getAttribute("value")?"on":a.value;b=a.value}return"string"==typeof b?b.replace(/\r/g,""):null==b?"":b},pajamas.serializeArray=function(){var a,b,c=[],d=/\r?\n/g,e=/radio|checkbox/i,f=function(a){var b,f,g,h;for(g=0;g<a.length;g++)if(b=a[g],b.name&&!b.disabled&&(e.test(b.type)?b.checked:!0)&&(f=pajamas.val(b),null!=f))if(isArray(f))for(h=0;h<f.length;h++)c.push({name:b.name,value:f[h].replace(d,"\r\n")});else c.push({name:b.name,value:f.replace(d,"\r\n")})};for(a=0;a<arguments.length;a++)b=arguments[a],b.elements?f(b.elements):f([b]);return c},pajamas.serialize=function(){return pajamas.param(pajamas.serializeArray.apply(null,arguments))},pajamas});